library(rstan)

# Get the data and put them into 3D array
bdat <- read.table("fritillary.txt", header = TRUE)

y <-
  structure(c(0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
              0, 0, NA, 0, NA, 0, 0, 0, 0, 0, NA, 0, 0, 0, NA, 0, 0, NA, 0, 
              0, 0, 0, NA, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, NA, 0, 0, 0, 0, 0, 
              0, NA, 0, 0, 0, 0, 0, 1, 0, 0, NA, 0, 0, 0, NA, 0, 0, 0, NA, 
              NA, NA, 0, NA, 0, 0, NA, 0, 0, 0, 0, 0, 0, 0, NA, NA, NA, NA, 
              0, NA, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 
              0, NA, 0, NA, 0, 0, 0, 0, 0, NA, 0, 0, 0, NA, 0, 0, NA, 0, 0, 
              0, 0, NA, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, NA, 0, 0, 0, 0, 0, 0, 
              NA, 0, 0, 0, 0, 0, 0, 0, 0, NA, 0, 0, 0, NA, 0, 0, 0, NA, NA, 
              NA, 0, NA, 0, 0, NA, 0, 0, 0, 0, 0, 0, 0, NA, NA, NA, NA, 0, 
              NA, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
              0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, NA, 0, 0, NA, 0, 0, 0, 0, 
              NA, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, NA, 0, 0, 0, 0, 0, 0, 0, 0, 
              0, 0, 0, 0, 0, 0, 0, NA, 0, 0, 0, NA, 0, 0, 0, 0, 0, NA, 0, 0, 
              0, 0, NA, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
              0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
              0, 0, 0, 0, 0, 0, NA, 0, 0, NA, 0, 0, 0, 0, NA, 0, 0, 0, 0, 0, 
              0, 0, 0, 0, 0, NA, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
              0, NA, 0, 0, 0, NA, 0, 0, 0, 0, 0, NA, 0, 0, 0, 0, NA, 0, 0, 
              0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 1, 
              0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
              0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
              0, 5, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
              1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
              0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
              0, 0, 2, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
              0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 7, 0, 0, 0, 0, 0, 0, 0, 0, 
              0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
              0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 0, 1, 0, 0, 2, 
              0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 4, 0, 0, 0, 
              1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
              0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 2, 1, 2, 0, 0, 0, 0, 0, 0, 0, 0, 
              0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 
              0, 0, 0, 0, 0, 3, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 
              0, 0, 0, 2, 0, 1, 0, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 
              0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 4, 0, 2, 0, 0, 0, 0, 0, 
              1, 1, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 
              0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 1, 7, 0, 0, 0, 1, 
              1, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 1, 0, 0, 
              0, 2, 0, 0, 9, 0, 0, 0, 0, 1, 0, 0, 0, 0, 3, 0, 1, 0, 0, 0, 0, 
              0, 0, 0, 5, 0, 0, 0, 0, 0, 0, 0, 9, 3, 1, 2, 13, 0, 0, 2, 0, 
              0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 
              0, 0, 0, 0, 0, 2, 0, 6, 0, 1, 1, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 
              1, 0, 0, 0, 0, 1, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 3, 0, 0, 0, 0, 
              0, 0, 0, 0, 0, 9, 1, 1, 0, 0, 1, 3, 0, 0, 2, 3, 0, 1, 0, 0, 0, 
              0, 0, 4, 4, 2, 4, 8, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
              3, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 2, 0, 0, 1, 0, 2, 0, 2, 
              0, 0, 10, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 3, 0, 0, 0, 
              0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 1, 0, 0, 
              0, 0, 1, 0, 0, 0, 6, 1, 0, 0, 0, 0, 0, 1, 7, 2, 2, 0, 5, 0, 1, 
              4, 0, 0, 0, 0, 4, 0, 0, 0, 1, 0, 0, 2, 0, 1, 0, 0, 0, 0, 0, 0, 
              0, 0, 0, 0, 0, 0, 0, 2, 0, 4, 0, 3, 0, 0, 7, 0, 0, 0, 0, 0, 0, 
              3, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 
              0, 1, 0, 0, 0, 0, 0, 3, 0, 0, 1, 0, 0, 0, 0, 0, 0, 5, 0, 0, 0, 
              0, 0, 0, 1, 14, 2, 1, 0, 10, 0, 0, 2, 0, 0, 0, 0, 3, 0, 0, 0, 
              3, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 
              1, 0, 1, 0, 0, 9, 0, 0, 0, 0, 0, 0, 1, 0, 0, 1, 0, 0, 0, 1, 0, 
              0, 0, 1, 0, 0, 0, 1, NA, 0, 0, NA, 0, 0, 0, 0, NA, 0, 0, 1, 0, 
              0, 1, 0, 0, 0, 0, NA, 0, 1, 2, 0, 1, 3, 0, 0, 0, 1, 6, 2, 3, 
              0, 3, NA, 1, 1, 0, NA, 0, 1, 2, 0, 0, NA, 1, 0, 0, 0, NA, 1, 
              0, 0, 0, 0, 2, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 8, 
              0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 2, 2, 0, 0, 0, 0, 0, 0, 0, 
              0, NA, 0, 1, NA, 0, 0, 0, 0, NA, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 
              NA, 0, 0, 6, 0, 0, 1, 0, 0, 0, 0, 5, 1, 1, 0, 1, NA, 0, 0, 0, 
              NA, 0, 1, 3, 0, 0, NA, 1, 0, 0, 1, NA, 0, 0, 0, 0, 0, 1, 0, 0, 
              0, 0, 0, 0, 0), .Dim = c(95L, 2L, 7L))

y # Look at data set in 3D layout
str(y)
# Have a look at raw data
day.max <- apply(y, c(1, 3), max, na.rm = TRUE) # Max count each site and day
day.max
site.max <- apply(day.max, 1, max, na.rm = TRUE) # Max count each site
site.max

table(site.max) # Frequency distribution of max counts
par(mfrow = c(1, 1))
plot(table(site.max))

table(site.max>0) # Observed occupancy is only 56%

# Sum of observed max as conventional estimator of total abundance
max1 <- apply(y, c(1, 3), max)
obs.max.sum <- apply(max1, 2, sum, na.rm = TRUE)
obs.max.sum
# should be: 4 0 15 32 99 85 63

# Bundle data
R = nrow(y)
T = ncol(y)
stan.data <- list(y = y, R = R, T = T)

# Initial values
Nst <- apply(y, c(1, 3), max) + 1
Nst[is.na(Nst)] <- 1
inits <- function(){list(N = Nst, alpha.lam = runif(7, -1, 1))}

# Parameters monitored
params <- c("totalN", "mean.abundance", "alpha.lam", "p", "fit",
            "fit.new")

# MCMC settings
ni <- 10000
nt <- 8
nb <- 2000
nc <- 3

# Call STAN from R (BRT 1 min)
stan_model_covariate <- "./open_pop_bin_mixture_model.stan"

out0 <- stan(stan_model_covariate,
             data = stan.data, 
             init = inits, 
             pars = params,
             chains = nc, iter = ni, 
             warmup = nb, thin = nt,
             seed = 1,
             open_progress = FALSE,
             cores = 3)

# Summarize posteriors
print(out0, dig = 3)